# ステップ4: Act – 操作負荷の最小化（行動設計）

## 目的
- 小規模事業者が日次で行う主要タスク（売上・在庫・粗利・資金確認、エクスポート）について、必要な操作を3クリック以内に抑える。
- `st.session_state`を活用し、前回選択した期間・店舗などのコンテキストを保持して入力のやり直しを防ぐ。
- 空・待機・エラー状態に対応したメッセージを定義し、迷いが生じた際の再操作動線を明示する。

## 1. 理想フローとクリック数比較
| タスク | 現状フロー（推定クリック数） | 理想フロー（3クリック以内） | クリック数削減 | 実装メモ |
| --- | --- | --- | --- | --- |
| 売上確認 | ①サイドバーから「売上」を選択（1）→②期間を選択（1）→③店舗を選択（1）→④グラフ・テーブル読み込みまで待機→⑤必要に応じて分解セクションへスクロール（1） ※計4〜5クリック | ①トップ画面に売上カード・トレンドがデフォルト表示。`st.session_state`で前回選択した期間・店舗を保持し、自動セット。<br>②必要なら期間・店舗のドロップダウンを変更（1クリック）<br>③分解タブ（商品/チャネル）をタブUIで切替（1クリック）<br>※閲覧のみなら0クリック | 5→2（▲60%） | - 初期化時に`st.session_state.setdefault("selected_period", default_period)`等を呼び出し。<br>- `st.tabs()`で分解軸を整理し、スクロール量を削減。 |
| 在庫確認 | ①「在庫」タブをクリック（1）→②店舗・カテゴリを選択（2）→③在庫リストをスクロール（1）→④発注画面遷移（1）→⑤戻る（1） ※計5〜6クリック | ①タブ選択（1）後、自動的に最後に確認した店舗が選択され、カテゴリは全件表示。<br>②不足在庫（閾値未満）のみを事前にフィルタしたカードを表示。<br>③必要に応じて「すべて表示」「カテゴリ選択」をトグルボタンで切替（1クリック）。<br>④発注リンクは各行に配置し、クリックで発注画面へ遷移（1クリック）。 | 6→3（▲50%） | - `st.session_state.setdefault("selected_store", default_store)`で初期値を確保。<br>- 阈値設定を`st.slider`で保持し、不足カード→全件表示の切替は`st.segmented_control`で実装。 |
| 粗利確認 | ①「粗利」タブ選択（1）→②期間選択（1）→③売上・原価・経費を個別ページで確認（2） ※計4クリック | ①「粗利」タブ内に売上・原価・経費の指標カードを1つのセクションにまとめる。<br>②期間は`st.session_state`でデフォルトセットし、必要なら変更（1クリック）。<br>③分解タブで商品/チャネル別粗利を切替（1クリック）。 | 4→2（▲50%） | - KPIカードは`st.columns([1,1,1])`で横並び。<br>- 詳細テーブルは下部に固定し、タブ切替だけで内訳比較が可能。 |
| 資金確認 | ①「資金」タブ選択（1）→②現預金推移グラフをスクロール（1）→③入出金明細をテーブルで確認（1） ※計3クリック | ①タブ選択後、KGIカードとCFトレンドを即表示（デフォルト期間は前回の設定）。<br>②入出金明細テーブルはセクションとして用意し、スクロールなしで閲覧可。フィルタ変更が必要な場合のみ1クリック。 | 3→1（▲67%） | - `st.container(border=True)`を用いてカードを上部固定。<br>- 明細テーブルのページネーションを既定で有効化し、スクロール負担を削減。 |
| CSV/PDF出力 | ①エクスポートボタンを探してクリック（1）→②CSVかPDFを選択（1）→③ファイル名を確認してダウンロード（1） ※計3クリック | ①明細テーブルの右上に`st.download_button`を配置し、クリック一回で現在のフィルタ条件を反映したCSV/PDFを自動生成し、ファイル名に「売上_2025-09_本店.csv」のように期間・店舗名を含める。 | 3→1（▲67%） | - `download_button`呼び出し時に`file_name=f"売上_{period}_{store}.csv"`を指定。<br>- 生成済みデータは`BytesIO`キャッシュに保持し、再計算を回避。 |

## 2. 空・待機・エラー状態のメッセージ設計
| 状態キー | 発生場面 | メッセージ例 | 再操作案内 | 実装メモ |
| --- | --- | --- | --- | --- |
| `no_data` | 選択した期間・店舗に該当データがない | 該当期間のデータはありません。期間や店舗を変更して再度お試しください。 | `st.button("別の期間を選ぶ")` を表示し、クリックで日付ピッカーを開く。 | `st.session_state["status"] = "no_data"`とし、共通レンダラーでメッセージとボタンを描画。 |
| `loading` | データを取得中 | データを読み込んでいます… | インジケータを表示し、処理が完了すると自動的に内容を更新。 | `st.spinner`またはプレースホルダにローディングアニメーションを入れ、完了後に内容差し替え。 |
| `error` | APIやDBエラー、予期せぬ例外 | データ取得に失敗しました。数分後に再度お試しください。 | `st.button("再読み込み")` を表示し、クリック時に再実行。 | 例外時は詳細をログにのみ出力し、ユーザーには単純な対処法のみ提示。 |
| `empty_filter` | フィルタによって結果が空 | 該当する項目がありません。フィルタ条件を緩めてください。 | フィルタ条件をリセットするボタンを表示。 | `st.session_state["selected_filters"]`を初期値に戻し、UIにも反映。 |
| `success_export` | CSV/PDF出力完了 | ファイルをダウンロードしました。ご確認ください。 | 特になし。ダウンロード完了後、通知バナーを数秒表示して自動的にフェードアウト。 | `st.toast`または`st.success`に`icon="📁"`を指定し、`st.session_state.pop("status", None)`でクリア。 |

- 状態管理は`st.session_state.setdefault("status", None)`で初期化し、イベント発生時に更新する。
- 状態メッセージは画面上部に配置し、`st.toast()`や`st.info()`を用いて視線を誘導する。
- エラーの詳細はサーバーログに記録し、UIでは認知負荷の低い簡潔な文言を維持する。

## 3. 効果の推定
- 売上確認タスクのクリック数が5→2に減ると仮定すると、1回あたりの操作時間は約60秒→20秒へ短縮。<br>`(60−20)秒 × 5回/日 × 20営業日 = 3,333秒（約55分）`の節約。
- 同様の改善を粗利・資金確認に適用すると、月2〜3時間の削減が期待できる。
- 期間・店舗などの既定値保持により、入力ミスや設定忘れの誤操作率は50%以上低減する見込み。再入力によるフロー中断が減り、意思決定にかかるリードタイムが短縮される。

## 次アクション
1. 各タブで利用するフィルタ初期値を`st.session_state`で統一管理し、再訪問時の自動入力を確認する統合テストを追加。
2. 状態メッセージの共通コンポーネントを`ui_widgets.py`に実装し、各ページから呼び出せるようにする。
3. 新しいタブ構造とカードレイアウトのモックをStreamlitでプロトタイピングし、ユーザーテストでクリック数とTime-on-Taskを計測する。

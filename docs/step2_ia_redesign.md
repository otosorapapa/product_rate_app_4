# ステップ2: 情報設計・導線再設計

## 目的とコンセプト
- 現状診断で浮上した「意思決定に必要な指標が分散している」「モバイル表示での視認性が低い」という課題を解消する。
- KGIは**意思決定時間の短縮**と**誤判断の低減**。これに直結する3指標（売上・粗利・資金）を常時可視化し、サマリ→要因分析→明細の順に情報を深掘りできるIAを設計する。
- Streamlitの`layout="wide"`を前提に12カラム相当のグリッドを用意し、モバイル幅ではカードが縦積みになるレスポンシブ動作を想定する。

## サイトマップ
```text
Dashboard
├── 売上タブ
│   ├── 指標カード（売上高・前期比）
│   ├── トレンド折れ線グラフ（期間別売上）
│   ├── 分解セクション
│   │    ├── 商品別売上（棒グラフ）
│   │    ├── チャネル別売上（棒グラフ）
│   │    └── 店舗別売上（棒グラフ）
│   ├── 明細テーブル（商品名/数量/金額）
│   └── CSV/PDF出力ボタン
│
├── 粗利タブ
│   ├── 指標カード（粗利額・粗利率・前期比）
│   ├── トレンドグラフ
│   ├── 分解（商品別・チャネル別・店舗別）
│   └── 明細テーブル
│
├── 在庫タブ
│   ├── 指標カード（在庫総額・回転率・不足数）
│   ├── 在庫トレンド
│   ├── 分解（カテゴリ別残数）
│   └── 明細テーブル＋発注リンク
│
├── 資金タブ
│   ├── 指標カード（現預金残高・キャッシュフロー）
│   ├── トレンドグラフ（週次CF）
│   ├── 入出金分析
│   └── 明細テーブル
│
└── レポートタブ
    ├── 日次/週次/月次レポート一覧
    └── ダウンロードリンク
```

### タブ別の要点
- **売上タブ**: POS/会計連携データをもとに粗利へとつながる流れを示す。商品・チャネル・店舗の3軸を同一画面に並べ、異常を発見しやすくする。
- **粗利タブ**: `df_view`で算出済みの粗利/付加価値指標を再利用し、シナリオ比較・差分の表示もここに統合する。
- **在庫タブ**: 在庫CSVを取り込む拡張を見据え、カテゴリ別残数と不足警告を中心に設計。発注リンクは在庫行ごとに`st.link_button`で提供する想定。
- **資金タブ**: `external_sync_last_transactions`のキャッシュフロー集計をベースに、週次ラインチャートと入出金内訳（テーブル + 集計チャート）を並置する。
- **レポートタブ**: 既存のシナリオ比較・感度分析・異常値レビュー・PDCAログなど詳細分析機能を丸ごと移設し、ドキュメント出力ボタン（CSV/PDF）もここで完結させる。

## トップ画面の情報優先度マトリクス

| 優先度 | 表示内容 | 理由/実装メモ |
| --- | --- | --- |
| 高 | **KGI直結指標カード：売上・粗利・資金** | 3指標を固定表示し、数値＋前期比矢印＋スパークラインを表示。`st.columns([4,4,4])`で均等配置し、横スクロール無しでモバイルでもカード全体が視認できるようにする。 |
| 中 | **フィルタコントロール（期間選択・店舗選択）** | `st.session_state`で最新選択を保持し、再訪時の入力負荷を軽減。期間は月次を既定、店舗はPOS連携の`source`列を利用。 |
| 中 | **トレンドグラフ（折れ線）** | KPI変化を俯瞰し異常を早期発見。期間と店舗フィルタを反映した`altair`折れ線グラフをカード直下に配置し、カード内スパークラインと整合を取る。 |
| 中 | **分解グラフ（棒グラフ）** | 商品・チャネル・店舗別の構成比を可視化。`st.columns([1,1])`で2列配置し、スクロール量を抑える。 |
| 低 | **明細テーブル** | 詳細分析用にページ下部へ配置。列ヘッダ固定、並び替え、全文検索、ページネーションを有効化し、1クリックでCSV出力可能にする。 |
| 低 | **CSV/PDF出力ボタン** | タブ末尾にボタンをまとめ、クリック後のトーストで完了通知。ラベルにはファイル形式と対象指標を明示する。 |

## ASCIIワイヤー（トップ画面例）
```text
┌───────────────────────────────────────────────┐
│ 売上高 ¥1,200,000 ▲10%   粗利 ¥400,000 ▼5%   現預金 ¥3,500,000 ▲8% │
├───────────────────────────────────────────────┤
│ [期間: 今月 ▼]  [店舗: 本店 ▼]                                         │
├───────────────────────────────────────────────┤
│               売上トレンド（折れ線グラフ）                               │
├───────────────┬──────────────────────────────┤
│ 商品別売上（棒グラフ） │ チャネル別売上（棒グラフ）                    │
├───────────────┴──────────────────────────────┤
│ 明細テーブル：商品名 | 数量 | 売上 | 粗利 | 在庫残         │  [CSV DL] │
└───────────────────────────────────────────────┘
```
- Streamlitの`st.columns`で12カラム相当（4:4:4など）に分割し、カードの角丸は8px、影は`box-shadow: 0 4px 12px rgba(11,31,59,0.08)`程度の弱い陰影とする。
- 余白は8px単位で統一し、モバイル幅ではカードが縦方向に並ぶよう`st.container(border=True)`を活用する。
- カラーパレット: `Primary=#0B1F3B`, `Secondary=#5A6B7A`, `Accent=#1E88E5`, 背景は `#F7F8FA`。アクセント色は前期比矢印や選択中タブに使用。

## インタラクション設計と実装メモ
- 期間・店舗フィルタは`st.form`内にまとめて「更新」ボタンを配置し、不要な再描画を抑制する。選択値は`st.session_state["dashboard_filters"]`で永続化。
- KPIカードにはミニスパークラインを描画するため、`altair`で幅100px程度の折れ線を生成し、`st.markdown`内にSVGとして埋め込む案を採用。
- 明細テーブルは`st.data_editor`の`column_config`を活用し、粗利率や在庫残などの派生指標をバッジ表示にする。
- 「在庫タブ」の発注リンクは`mailto:`形式または在庫管理シートURLに遷移できるようにし、即時のアクションにつなげる。
- 「資金タブ」では日次CFの積み上げ棒グラフと、入出金カテゴリ別のドーナツチャートを縦並びに配置。`external_sync_last_transactions`が空の場合はサンプルデータを自動読み込み、実務での利用イメージを途切れさせない。

## 効果見込み（フェルミ推定）
- **認知負荷の低減**: KGI指標を常時表示し、タブ構造を整理することでユーザーが情報を探す時間を平均30秒→10秒に短縮。5回/日利用なら月20営業日で約33分削減。
- **クリック数の削減**: フィルタ既定値の保持とタブ統合により、主要タスクのクリック数を5回→2〜3回へ削減。1クリック=約2秒とすると月に約1,200クリック（約40分）の削減。
- **誤操作率の低減**: 階層化された情報設計と明確なアクションボタンにより誤操作が半減すると仮定。意思決定の誤りを抑制し、過剰在庫や値決めの失敗による機会損失を軽減できる。

## 次ステップ
1. サンプルデータを用いたモック実装を`pages/02_ダッシュボード.py`に追加し、トグルで旧UIと切り替え可能にする。
2. フィルタ保持・スパークライン描画など共通ロジックを`ui_layout.py`にユーティリティとして整理する。
3. 在庫CSV・キャッシュフロー集計のデータモデルを整備し、`data_integrations.py`に入出金カテゴリのマッピング関数を追加する。
4. ステップ3（Check）のユーザーテスト観察項目に「KGIカードの理解度」「モバイル時の操作感」を追記し、改善効果を定量確認する。
